<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Goal App</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont;
  background: #f2f2f7;
  padding: 20px;
}
h1 { font-size: 24px; }
.card {
  background: white;
  padding: 15px;
  margin-top: 15px;
  border-radius: 15px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}
button {
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  background: black;
  color: white;
  margin-top:5px;
}
input {
  padding: 8px;
  margin-top: 5px;
}
</style>
</head>
<body>

<h1>Goal Tracker</h1>

<div class="card">
  <input id="goalName" placeholder="目標名"><br>
  <input id="periodDays" type="number" placeholder="何日間で"><br>
  <input id="limitCount" type="number" placeholder="何回まで"><br>
  <button onclick="addGoal()">目標追加</button>
</div>

<div id="goals"></div>

<script>
let goals = JSON.parse(localStorage.getItem("goals")) || [];

function save() {
  localStorage.setItem("goals", JSON.stringify(goals));
}

function today() {
  return new Date();
}

function daysBetween(a,b) {
  return Math.floor((a - b) / (24*60*60*1000));
}

function addGoal() {
  const name = document.getElementById("goalName").value;
  const periodDays = parseInt(document.getElementById("periodDays").value);
  const limitCount = parseInt(document.getElementById("limitCount").value);

  if (!name || !periodDays || limitCount < 0) return;

  goals.push({
    name,
    periodDays,
    limitCount,
    records: [],
    fails: 0,
    createdAt: Date.now()
  });

  save();
  render();
}

function checkGoal(index) {
  const goal = goals[index];
  const now = Date.now();

  goal.records.push(now);

  // 現在期間内の回数を計算
  const validRecords = goal.records.filter(r =>
    daysBetween(new Date(now), new Date(r)) < goal.periodDays
  );

  if (validRecords.length > goal.limitCount) {
    goal.fails++;
  }

  if (goal.fails >= 3) {
    goals.splice(index,1);
  }

  save();
  render();
}

function getCurrentCount(goal) {
  const now = Date.now();
  return goal.records.filter(r =>
    daysBetween(new Date(now), new Date(r)) < goal.periodDays
  ).length;
}

function render() {
  const container = document.getElementById("goals");
  container.innerHTML = "";

  goals.forEach((g,i) => {
    const count = getCurrentCount(g);

    container.innerHTML += `
      <div class="card">
        <b>${g.name}</b><br>
        制限：${g.periodDays}日で${g.limitCount}回まで<br>
        現在期間内：${count}回<br>
        失敗：${g.fails}回<br>
        <button onclick="checkGoal(${i})">記録</button>
      </div>
    `;
  });
}

render();
</script>

</body>
</html>
