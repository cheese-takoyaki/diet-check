<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Goal App</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont;
  background: #f2f2f7;
  padding: 20px;
}
h1 { font-size: 24px; }
.card {
  background: white;
  padding: 15px;
  margin-top: 15px;
  border-radius: 15px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}
button {
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  background: black;
  color: white;
  margin-top:5px;
}
input, select {
  padding: 8px;
  margin-top: 5px;
}
.streak {
  font-size: 14px;
  color: #666;
}
</style>
</head>
<body>

<h1>Goal Tracker</h1>

<div class="card">
  <input id="goalName" placeholder="目標名"><br>
  <input id="goalLimit" type="number" placeholder="回数"><br>

  <select id="goalType">
    <option value="week">週に◯回まで</option>
    <option value="month">月に◯回まで</option>
    <option value="days">◯日に1回まで</option>
  </select><br>

  <button onclick="addGoal()">目標追加</button>
</div>

<div id="goals"></div>

<script>
let goals = JSON.parse(localStorage.getItem("goals")) || [];

function save() {
  localStorage.setItem("goals", JSON.stringify(goals));
}

function today() {
  return new Date();
}

function formatDate(d) {
  return d.toISOString().split("T")[0];
}

function getPeriodKey(goal) {
  const now = today();

  if (goal.type === "week") {
    const first = new Date(now.getFullYear(), 0, 1);
    const week = Math.floor((now - first) / (7 * 24 * 60 * 60 * 1000));
    return "week-" + week;
  }

  if (goal.type === "month") {
    return "month-" + now.getFullYear() + "-" + now.getMonth();
  }

  if (goal.type === "days") {
    const start = new Date(goal.createdAt);
    const diff = Math.floor((now - start) / (24*60*60*1000));
    const block = Math.floor(diff / goal.limit);
    return "block-" + block;
  }
}

function addGoal() {
  const name = document.getElementById("goalName").value;
  const limit = parseInt(document.getElementById("goalLimit").value);
  const type = document.getElementById("goalType").value;

  if (!name || !limit) return;

  goals.push({
    name,
    limit,
    type,
    history: {},
    fails: 0,
    streak: 0,
    createdAt: Date.now()
  });

  save();
  render();
}

function checkGoal(index) {
  const goal = goals[index];
  const key = getPeriodKey(goal);

  goal.history[key] = (goal.history[key] || 0) + 1;

  if (goal.type === "days") {
    if (goal.history[key] > 1) goal.fails++;
  } else {
    if (goal.history[key] > goal.limit) goal.fails++;
  }

  if (goal.fails >= 3) {
    goals.splice(index,1);
  }

  save();
  render();
}

function render() {
  const container = document.getElementById("goals");
  container.innerHTML = "";

  goals.forEach((g,i) => {
    const key = getPeriodKey(g);
    const count = g.history[key] || 0;

    let label = "";
    if (g.type === "week") label = "週";
    if (g.type === "month") label = "月";
    if (g.type === "days") label = g.limit + "日に1回";

    container.innerHTML += `
      <div class="card">
        <b>${g.name}</b><br>
        制限：${label} / ${g.limit}回<br>
        今期：${count}回<br>
        失敗：${g.fails}回<br>
        <button onclick="checkGoal(${i})">記録</button>
      </div>
    `;
  });
}

render();
</script>

</body>
</html>
